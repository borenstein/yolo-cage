# Network policies for yolo-cage v2
#
# Architecture:
#   yolo-cage pods -> git-dispatcher (git operations)
#                  -> egress-proxy (HTTP/HTTPS, scanned)
#                  -> direct HTTPS (for PROXY_BYPASS hosts, unscanned)
#                  -> DNS
#
#   git-dispatcher -> GitHub (HTTPS only)
#                  -> workspaces (filesystem, not network)
#
#   egress-proxy -> LLM-Guard (scanning)
#               -> Internet (allowed traffic only)
#
# SSH is blocked - all git goes through the dispatcher

---
# yolo-cage pods: can reach dispatcher, proxy, DNS, and direct HTTPS (for bypassed hosts)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: yolo-cage-egress
spec:
  podSelector:
    matchLabels:
      app: yolo-cage
  policyTypes:
    - Egress
  egress:
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Git dispatcher (all git operations go through here)
    - to:
        - podSelector:
            matchLabels:
              app: git-dispatcher
      ports:
        - protocol: TCP
          port: 8080

    # Egress proxy (HTTP/HTTPS that gets scanned)
    - to:
        - podSelector:
            matchLabels:
              app: egress-proxy
      ports:
        - protocol: TCP
          port: 8080

    # Direct HTTP/HTTPS for PROXY_BYPASS hosts (api.anthropic.com, etc.)
    # NO_PROXY env var tells apps which hosts bypass the proxy
    # These connections are NOT scanned - only bypass trusted services
    - to: []
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443

---
# Git dispatcher: can reach GitHub, Kubernetes API, and internal services
# The dispatcher is a trusted component that manages pod lifecycle
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: git-dispatcher-policy
spec:
  podSelector:
    matchLabels:
      app: git-dispatcher
  policyTypes:
    - Egress
  egress:
    # DNS
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Kubernetes API - service CIDR (10.152.183.0/24) and host network
    # The API server runs on the host, accessed via kubernetes.default.svc
    # which DNATs to the host IP on port 16443
    - to:
        - ipBlock:
            cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 16443

    - to:
        - ipBlock:
            cidr: 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 16443

    # GitHub (HTTPS) - for git operations
    - ports:
        - protocol: TCP
          port: 443

---
# Egress proxy: can reach LLM-Guard and internet
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: egress-proxy-policy
spec:
  podSelector:
    matchLabels:
      app: egress-proxy
  policyTypes:
    - Egress
  egress:
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # LLM-Guard for secret scanning
    - to:
        - podSelector:
            matchLabels:
              app: llm-guard
      ports:
        - protocol: TCP
          port: 8000

    # Internet (HTTP, HTTPS only - no SSH)
    - to: []
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443

---
# LLM-Guard: DNS only (pure scanner)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: llm-guard-policy
spec:
  podSelector:
    matchLabels:
      app: llm-guard
  policyTypes:
    - Egress
  egress:
    # DNS only (required for healthchecks)
    - to: []
      ports:
        - protocol: UDP
          port: 53
