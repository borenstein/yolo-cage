# Yolo-cage sandbox - Claude Code development environment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: yolo-cage
  namespace: claude-sandbox  # CHANGE to match your namespace
  labels:
    app: yolo-cage
spec:
  replicas: 1
  strategy:
    type: Recreate  # Don't run multiple instances
  selector:
    matchLabels:
      app: yolo-cage
  template:
    metadata:
      labels:
        app: yolo-cage
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

      initContainers:
        # Create combined CA bundle (system CAs + proxy CA)
        - name: setup-ca
          image: python:3.12-slim-bookworm
          command:
            - /bin/sh
            - -c
            - |
              cat /etc/ssl/certs/ca-certificates.crt /proxy-ca/mitmproxy-ca.pem > /ca-bundle/ca-certificates-combined.crt
              chmod 644 /ca-bundle/ca-certificates-combined.crt
          volumeMounts:
            - name: proxy-ca
              mountPath: /proxy-ca
              readOnly: true
            - name: ca-bundle
              mountPath: /ca-bundle

      containers:
        - name: yolo-cage
          image: localhost:32000/yolo-cage:latest  # CHANGE to your registry
          imagePullPolicy: Always

          env:
            - name: HOME
              value: /home/dev
            - name: TERM
              value: xterm-256color
            # Route HTTP/HTTPS through scanning proxy
            - name: HTTP_PROXY
              value: "http://egress-proxy:8080"
            - name: HTTPS_PROXY
              value: "http://egress-proxy:8080"
            - name: http_proxy
              value: "http://egress-proxy:8080"
            - name: https_proxy
              value: "http://egress-proxy:8080"
            # Don't proxy internal cluster traffic
            - name: NO_PROXY
              value: "localhost,127.0.0.1,.cluster.local,.svc,10.0.0.0/8"
            - name: no_proxy
              value: "localhost,127.0.0.1,.cluster.local,.svc,10.0.0.0/8"
            # Trust the proxy's CA cert for HTTPS interception
            - name: NODE_EXTRA_CA_CERTS
              value: "/etc/ssl/certs/mitmproxy-ca.pem"
            - name: REQUESTS_CA_BUNDLE
              value: "/etc/ssl/certs/ca-certificates-combined.crt"
            - name: SSL_CERT_FILE
              value: "/etc/ssl/certs/ca-certificates-combined.crt"

          resources:
            requests:
              cpu: "1"
              memory: "4Gi"
            limits:
              cpu: "8"
              memory: "32Gi"

          volumeMounts:
            - name: workspace
              mountPath: /workspace
            - name: secrets
              mountPath: /secrets
              readOnly: true
            - name: config
              mountPath: /config
              readOnly: true
            - name: claude-data
              mountPath: /home/dev/.claude
            - name: proxy-ca
              mountPath: /etc/ssl/certs/mitmproxy-ca.pem
              subPath: mitmproxy-ca.pem
              readOnly: true
            - name: ca-bundle
              mountPath: /etc/ssl/certs/ca-certificates-combined.crt
              subPath: ca-certificates-combined.crt
              readOnly: true

          # Keep container alive
          command: ["sleep", "infinity"]

      volumes:
        - name: workspace
          persistentVolumeClaim:
            claimName: yolo-cage-workspace

        - name: secrets
          secret:
            secretName: yolo-cage-credentials
            items:
              - key: ssh-private-key
                path: ssh-private-key
                mode: 0600
              - key: claude-oauth-credentials
                path: claude-oauth-credentials
                mode: 0600

        - name: config
          configMap:
            name: yolo-cage-config

        - name: claude-data
          persistentVolumeClaim:
            claimName: yolo-cage-claude-data

        - name: proxy-ca
          configMap:
            name: proxy-ca

        - name: ca-bundle
          emptyDir: {}
