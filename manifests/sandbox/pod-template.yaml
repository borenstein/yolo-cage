# yolo-cage v2 pod template
# This is NOT applied directly - the CLI uses it as a template
# Variables replaced by CLI: ${BRANCH}, ${NAMESPACE}
apiVersion: v1
kind: Pod
metadata:
  name: yolo-cage-${BRANCH}
  labels:
    app: yolo-cage
    yolo-cage/branch: ${BRANCH}
spec:
  restartPolicy: Never
  terminationGracePeriodSeconds: 5

  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  initContainers:
    # Create combined CA bundle (system CAs + proxy CA)
    - name: setup-ca
      image: python:3.12-slim-bookworm
      command:
        - /bin/sh
        - -c
        - |
          cat /etc/ssl/certs/ca-certificates.crt /proxy-ca/mitmproxy-ca.pem > /ca-bundle/ca-certificates-combined.crt
          chmod 644 /ca-bundle/ca-certificates-combined.crt
      volumeMounts:
        - name: proxy-ca
          mountPath: /proxy-ca
          readOnly: true
        - name: ca-bundle
          mountPath: /ca-bundle

    # Initialize Claude Code state (shared auth via .claude.json, per-branch sessions via .claude/)
    - name: setup-claude-home
      image: python:3.12-slim-bookworm
      env:
        - name: BRANCH
          value: "${BRANCH}"
      command:
        - /bin/sh
        - -c
        - |
          set -e
          # Per-branch .claude directory for session isolation
          STATE_DIR="/pvc/.claude-state/${BRANCH}"
          CLAUDE_DIR="${STATE_DIR}/.claude"
          # Shared .claude.json for auth propagation across all pods
          CLAUDE_JSON="/pvc/.claude.json"

          # Create per-branch .claude directory
          mkdir -p "${CLAUDE_DIR}"

          # Create shared .claude.json with minimal state to skip onboarding
          if [ ! -f "${CLAUDE_JSON}" ]; then
            cat > "${CLAUDE_JSON}" <<'EOF'
          {
            "hasCompletedOnboarding": true,
            "lastOnboardingVersion": "2.0.0"
          }
          EOF
          fi

          # Create CLAUDE.md if it doesn't exist
          if [ ! -f "${CLAUDE_DIR}/CLAUDE.md" ]; then
            cat > "${CLAUDE_DIR}/CLAUDE.md" <<'CLAUDE_EOF'
          # yolo-cage Environment

          You are running inside yolo-cage, a sandboxed environment for autonomous development.
          Claude Code is running in YOLO mode (--dangerously-skip-permissions), but the sandbox
          enforces containment at the infrastructure level.

          ## Your Constraints

          - **Branch isolation**: You can only commit/push to your assigned branch
          - **Read-only elsewhere**: You can read any branch, but cannot modify others
          - **No PR merging**: You may open PRs for human review, but cannot merge them
          - **Git enforcement**: Git operations go through a dispatcher that enforces these rules

          ## Your Capabilities

          - Full read access to the repository (all branches)
          - Read/write access to GitHub issues and PR comments
          - Can open pull requests on your branch
          - Can install packages, run tests, do anything inside this container
          - Full access to development tools (npm, pip, make, etc.)

          ## Workflow

          1. Work in this workspace (your branch is set via $YOLO_CAGE_BRANCH)
          2. Commit and push your changes
          3. When done, open a PR and explain what you built

          ## Notes

          - If git operations fail with "yolo-cage:" messages, that's the dispatcher enforcing rules
          - Your user reviews and merges PRs, not you
          CLAUDE_EOF
          fi
      volumeMounts:
        - name: workspaces
          mountPath: /pvc

  containers:
    - name: yolo-cage
      image: localhost:32000/yolo-cage:latest
      imagePullPolicy: Always

      env:
        - name: HOME
          value: /home/dev
        - name: TERM
          value: xterm-256color
        # Branch this pod is assigned to
        - name: YOLO_CAGE_BRANCH
          value: "${BRANCH}"
        - name: YOLO_CAGE_VERSION
          value: "0.2.0"
        # Git dispatcher endpoint
        - name: YOLO_CAGE_DISPATCHER
          value: "http://git-dispatcher:8080"
        # Route HTTP/HTTPS through scanning proxy
        - name: HTTP_PROXY
          value: "http://egress-proxy:8080"
        - name: HTTPS_PROXY
          value: "http://egress-proxy:8080"
        - name: http_proxy
          value: "http://egress-proxy:8080"
        - name: https_proxy
          value: "http://egress-proxy:8080"
        # Don't proxy internal cluster traffic, dispatcher, or user-configured bypasses
        - name: NO_PROXY
          value: "localhost,127.0.0.1,.cluster.local,.svc,10.0.0.0/8,git-dispatcher,${PROXY_BYPASS}"
        - name: no_proxy
          value: "localhost,127.0.0.1,.cluster.local,.svc,10.0.0.0/8,git-dispatcher,${PROXY_BYPASS}"
        # Trust the proxy's CA cert for HTTPS interception
        - name: NODE_EXTRA_CA_CERTS
          value: "/etc/ssl/certs/mitmproxy-ca.pem"
        - name: REQUESTS_CA_BUNDLE
          value: "/etc/ssl/certs/ca-certificates-combined.crt"
        - name: SSL_CERT_FILE
          value: "/etc/ssl/certs/ca-certificates-combined.crt"

      resources:
        requests:
          cpu: "${POD_CPU_REQUEST}"
          memory: "${POD_MEMORY_REQUEST}"
        limits:
          cpu: "${POD_CPU_LIMIT}"
          memory: "${POD_MEMORY_LIMIT}"

      volumeMounts:
        - name: workspaces
          mountPath: /home/dev/workspace
          subPath: ${BRANCH}
        - name: workspaces
          mountPath: /home/dev/.claude
          subPath: .claude-state/${BRANCH}/.claude
        - name: workspaces
          mountPath: /home/dev/.claude.json
          subPath: .claude.json
        - name: proxy-ca
          mountPath: /etc/ssl/certs/mitmproxy-ca.pem
          subPath: mitmproxy-ca.pem
          readOnly: true
        - name: ca-bundle
          mountPath: /etc/ssl/certs/ca-certificates-combined.crt
          subPath: ca-certificates-combined.crt
          readOnly: true
        - name: agent-prompt
          mountPath: /config/agent-prompt
          readOnly: true

      # Uses default CMD from Dockerfile (yolo-cage-init which registers then sleeps)

  volumes:
    - name: workspaces
      persistentVolumeClaim:
        claimName: yolo-cage-workspaces

    - name: proxy-ca
      configMap:
        name: proxy-ca

    - name: ca-bundle
      emptyDir: {}

    - name: agent-prompt
      configMap:
        name: yolo-cage-agent-prompt
        optional: true
