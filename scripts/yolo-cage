#!/bin/bash
# yolo-cage - CLI for managing sandboxed Claude Code agents
#
# Each agent gets its own pod with:
#   - Isolated branch (can only push to assigned branch)
#   - Git dispatcher integration (enforces branch rules, runs hooks)
#   - Egress proxy (scans for secrets)
#
# Usage:
#   yolo-cage create <branch> [-n namespace]
#   yolo-cage list [-n namespace]
#   yolo-cage attach <branch> [-n namespace]
#   yolo-cage delete <branch> [-n namespace]
#   yolo-cage logs <branch> [-n namespace]

set -e

# Default namespace
DEFAULT_NAMESPACE="yolo-cage"
NAMESPACE="${DEFAULT_NAMESPACE}"

# Find manifests base directory (where sandbox/, dispatcher/, proxy/ live)
# Priority: YOLO_CAGE_HOME > relative to script > system install location
find_manifests_dir() {
    # 1. Environment variable (explicit override)
    if [[ -n "${YOLO_CAGE_HOME:-}" && -d "${YOLO_CAGE_HOME}/manifests/base" ]]; then
        echo "${YOLO_CAGE_HOME}/manifests/base"
        return
    fi

    # 2. Relative to script (dev/cloned repo)
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [[ -d "${script_dir}/../manifests/base" ]]; then
        echo "${script_dir}/../manifests/base"
        return
    fi

    # 3. System install location
    if [[ -d "/usr/local/share/yolo-cage/manifests/base" ]]; then
        echo "/usr/local/share/yolo-cage/manifests/base"
        return
    fi

    # Not found
    echo ""
}

MANIFESTS_DIR="$(find_manifests_dir)"

# Parse global options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -n|--namespace)
            NAMESPACE="$2"
            shift 2
            ;;
        *)
            break
            ;;
    esac
done

COMMAND="${1:-}"
shift || true

usage() {
    cat <<EOF
yolo-cage - Sandboxed Claude Code agents with git isolation

Usage:
  yolo-cage create <branch> [-n namespace]   Create pod for branch
  yolo-cage list [-n namespace]              List active pods
  yolo-cage attach <branch> [-n namespace]   Exec into pod
  yolo-cage delete <branch> [-n namespace]   Remove pod
  yolo-cage logs <branch> [-n namespace]     Tail pod logs

Options:
  -n, --namespace NAME    Kubernetes namespace (default: ${DEFAULT_NAMESPACE})

Examples:
  yolo-cage create feature-auth
  yolo-cage attach feature-auth
  yolo-cage list
  yolo-cage delete feature-auth -n myproject
EOF
    exit 1
}

# Sanitize branch name for use in pod name (lowercase, replace / with -)
sanitize_branch() {
    echo "$1" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | tr '_' '-'
}

# Get pod name from branch
pod_name() {
    echo "yolo-cage-$(sanitize_branch "$1")"
}

# Wait for pod to be ready
wait_for_pod() {
    local pod="$1"
    local timeout=120
    local elapsed=0

    echo "Waiting for pod ${pod} to be ready..."
    while [[ $elapsed -lt $timeout ]]; do
        local status=$(kubectl get pod -n "${NAMESPACE}" "${pod}" -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
        if [[ "$status" == "Running" ]]; then
            # Check if the container is ready (init script has run)
            local ready=$(kubectl get pod -n "${NAMESPACE}" "${pod}" -o jsonpath='{.status.containerStatuses[0].ready}' 2>/dev/null || echo "false")
            if [[ "$ready" == "true" ]]; then
                return 0
            fi
        fi
        sleep 2
        elapsed=$((elapsed + 2))
        echo "  Status: ${status} (${elapsed}s)..."
    done

    echo "Error: Pod ${pod} did not become ready within ${timeout}s" >&2
    return 1
}

cmd_create() {
    local branch="$1"

    if [[ -z "$branch" ]]; then
        echo "Error: branch name required"
        echo "Usage: yolo-cage create <branch>"
        exit 1
    fi

    local pod=$(pod_name "$branch")

    # Check if pod already exists
    if kubectl get pod -n "${NAMESPACE}" "${pod}" &>/dev/null; then
        echo "Pod ${pod} already exists. Use 'yolo-cage attach ${branch}' to connect."
        exit 0
    fi

    echo "Creating pod for branch: ${branch}"
    echo "Namespace: ${NAMESPACE}"
    echo "Pod name: ${pod}"

    # Generate pod manifest from template
    if [[ -z "$MANIFESTS_DIR" ]]; then
        echo "Error: Could not find yolo-cage manifests directory."
        echo ""
        echo "Searched in:"
        echo "  - \$YOLO_CAGE_HOME/manifests/base (env var not set)"
        echo "  - $(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../manifests/base (not found)"
        echo "  - /usr/local/share/yolo-cage/manifests/base (not found)"
        echo ""
        echo "Either:"
        echo "  - Run from the cloned yolo-cage repo, or"
        echo "  - Set YOLO_CAGE_HOME to your yolo-cage directory, or"
        echo "  - Install manifests: sudo cp -r manifests /usr/local/share/yolo-cage/"
        exit 1
    fi

    local template="${MANIFESTS_DIR}/sandbox/pod-template.yaml"
    if [[ ! -f "$template" ]]; then
        echo "Error: Pod template not found at ${template}"
        exit 1
    fi

    # Read PROXY_BYPASS from egress-policy ConfigMap (or use default)
    local proxy_bypass
    proxy_bypass=$(kubectl get configmap -n "${NAMESPACE}" egress-policy -o jsonpath='{.data.PROXY_BYPASS}' 2>/dev/null || echo "api.anthropic.com")

    # Replace variables in template
    local manifest=$(sed \
        -e "s/\${BRANCH}/${branch}/g" \
        -e "s/\${NAMESPACE}/${NAMESPACE}/g" \
        -e "s/\${PROXY_BYPASS}/${proxy_bypass}/g" \
        "$template")

    # Apply the pod
    echo "$manifest" | kubectl apply -n "${NAMESPACE}" -f -

    # Wait for pod to be ready (includes registration with dispatcher)
    if ! wait_for_pod "$pod"; then
        echo "Error: Pod failed to start"
        echo "Check logs with: yolo-cage logs ${branch}"
        exit 1
    fi

    echo ""
    echo "Pod ${pod} is ready."
    echo ""
    echo "Launch Claude with:"
    echo "  yolo-cage attach ${branch}"
}

cmd_list() {
    echo "Active yolo-cage pods in namespace ${NAMESPACE}:"
    echo ""

    kubectl get pods -n "${NAMESPACE}" -l app=yolo-cage \
        -o custom-columns='NAME:.metadata.name,BRANCH:.metadata.labels.yolo-cage/branch,STATUS:.status.phase,IP:.status.podIP,AGE:.metadata.creationTimestamp' \
        2>/dev/null || echo "No pods found"

    echo ""
}

cmd_attach() {
    local branch="$1"

    if [[ -z "$branch" ]]; then
        echo "Error: branch name required"
        echo "Usage: yolo-cage attach <branch>"
        exit 1
    fi

    local pod=$(pod_name "$branch")

    if ! kubectl get pod -n "${NAMESPACE}" "${pod}" &>/dev/null; then
        echo "Error: Pod ${pod} not found"
        echo "Create it with: yolo-cage create ${branch}"
        exit 1
    fi

    echo "Launching Claude in ${pod}..."
    kubectl exec -it -n "${NAMESPACE}" "${pod}" -- \
        /bin/bash -c "cd /workspaces/${branch} && exec claude --dangerously-skip-permissions"
}

cmd_delete() {
    local branch="$1"

    if [[ -z "$branch" ]]; then
        echo "Error: branch name required"
        echo "Usage: yolo-cage delete <branch>"
        exit 1
    fi

    local pod=$(pod_name "$branch")

    if ! kubectl get pod -n "${NAMESPACE}" "${pod}" &>/dev/null; then
        echo "Pod ${pod} not found"
        exit 0
    fi

    echo "Deleting pod ${pod}..."
    kubectl delete pod -n "${NAMESPACE}" "${pod}"

    echo "Pod deleted."
    echo ""
    echo "Note: Workspace at /workspaces/${branch} is preserved."
    echo "Delete it manually if no longer needed."
}

cmd_logs() {
    local branch="$1"

    if [[ -z "$branch" ]]; then
        echo "Error: branch name required"
        echo "Usage: yolo-cage logs <branch>"
        exit 1
    fi

    local pod=$(pod_name "$branch")

    if ! kubectl get pod -n "${NAMESPACE}" "${pod}" &>/dev/null; then
        echo "Error: Pod ${pod} not found"
        exit 1
    fi

    kubectl logs -n "${NAMESPACE}" "${pod}" -f
}

# Main dispatch
case "$COMMAND" in
    create)
        cmd_create "$@"
        ;;
    list|ls)
        cmd_list
        ;;
    attach|exec)
        cmd_attach "$@"
        ;;
    delete|rm)
        cmd_delete "$@"
        ;;
    logs)
        cmd_logs "$@"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo "Unknown command: $COMMAND"
        usage
        ;;
esac
