#!/bin/bash
# yolo-cage gh shim
#
# Replaces /usr/bin/gh in sandbox containers.
# Delegates all gh CLI operations to the dispatcher service.
#
# The dispatcher authenticates by source IP, classifies commands,
# and executes the real gh command for allowed operations.
#
# File content transmission:
# - When --body-file <path> is used, the shim reads the file and transmits
#   its content to the dispatcher (since the dispatcher can't access sandbox files)
# - When --body-file - is used, the shim reads stdin and transmits it

set -e

DISPATCHER_URL="${YOLO_CAGE_DISPATCHER:-http://git-dispatcher:8080}"

# Get current working directory
CWD="$(pwd)"

# Collect file contents and stdin if needed
declare -A FILE_CONTENTS
STDIN_CONTENT=""
NEED_STDIN=false

# Scan args for --body-file
args=("$@")
for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[i]}" == "--body-file" ]] && ((i+1 < ${#args[@]})); then
        filepath="${args[i+1]}"
        if [[ "$filepath" == "-" ]]; then
            NEED_STDIN=true
        elif [[ -f "$filepath" ]]; then
            FILE_CONTENTS["$filepath"]=$(cat "$filepath")
        fi
    fi
done

# Read stdin if needed (must do this before any other stdin use)
if $NEED_STDIN; then
    STDIN_CONTENT=$(cat)
fi

# Build JSON payload using jq (required for proper escaping)
if ! command -v jq &>/dev/null; then
    echo "yolo-cage: jq is required but not installed" >&2
    exit 1
fi

# Build args array
ARGS_JSON=$(printf '%s\n' "$@" | jq -R . | jq -s .)

# Build files object
FILES_JSON="{}"
for path in "${!FILE_CONTENTS[@]}"; do
    FILES_JSON=$(echo "$FILES_JSON" | jq --arg p "$path" --arg c "${FILE_CONTENTS[$path]}" '. + {($p): $c}')
done

# Build complete payload
if [[ -n "$STDIN_CONTENT" ]]; then
    PAYLOAD=$(jq -n \
        --argjson args "$ARGS_JSON" \
        --arg cwd "$CWD" \
        --argjson files "$FILES_JSON" \
        --arg stdin "$STDIN_CONTENT" \
        '{args: $args, cwd: $cwd, files: $files, stdin: $stdin}')
else
    PAYLOAD=$(jq -n \
        --argjson args "$ARGS_JSON" \
        --arg cwd "$CWD" \
        --argjson files "$FILES_JSON" \
        '{args: $args, cwd: $cwd, files: $files}')
fi

# Make request to dispatcher
HEADER_FILE=$(mktemp)
trap "rm -f $HEADER_FILE" EXIT

RESPONSE=$(curl -sS \
    --connect-timeout 5 \
    -X POST \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD" \
    -D "$HEADER_FILE" \
    "$DISPATCHER_URL/gh" 2>&1) || {
    echo "yolo-cage: failed to connect to gh dispatcher" >&2
    echo "Error: $RESPONSE" >&2
    exit 1
}

# Extract exit code from header
EXIT_CODE=$(grep -i "X-Yolo-Cage-Exit-Code:" "$HEADER_FILE" | tr -d '\r' | awk '{print $2}')
EXIT_CODE="${EXIT_CODE:-0}"

# Output the response (this is gh's stdout/stderr combined)
echo -n "$RESPONSE"

exit "$EXIT_CODE"
