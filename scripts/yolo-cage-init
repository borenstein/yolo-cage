#!/bin/bash
# yolo-cage-init - Initialize sandbox and register with dispatcher
#
# This script runs when a yolo-cage pod starts. It:
#   1. Calls the dispatcher to bootstrap the workspace (clone repo, setup branch)
#   2. Registers this pod with the git dispatcher
#   3. Optionally runs a user-provided init script
#
# Note: User-level CLAUDE.md (sandbox instructions) is created by the
# setup-claude-home init container, not here.

set -e

BRANCH="${YOLO_CAGE_BRANCH:-}"
DISPATCHER="${YOLO_CAGE_DISPATCHER:-http://git-dispatcher:8080}"
WORKSPACE="/home/dev/workspace"

if [[ -z "$BRANCH" ]]; then
    echo "Error: YOLO_CAGE_BRANCH not set"
    exit 1
fi

echo "yolo-cage: Initializing sandbox for branch ${BRANCH}"

# Wait for dispatcher to be ready
echo "yolo-cage: Waiting for dispatcher..."
max_attempts=30
attempt=0
while [[ $attempt -lt $max_attempts ]]; do
    if curl -sf "${DISPATCHER}/health" >/dev/null 2>&1; then
        echo "yolo-cage: Dispatcher is ready"
        break
    fi
    attempt=$((attempt + 1))
    if [[ $attempt -lt $max_attempts ]]; then
        sleep 2
    else
        echo "yolo-cage: Error: Dispatcher not available after ${max_attempts} attempts"
        exit 1
    fi
done

# Bootstrap workspace (dispatcher clones repo with its credentials)
echo "yolo-cage: Bootstrapping workspace..."
bootstrap_response=$(curl -sf -X POST "${DISPATCHER}/bootstrap?branch=${BRANCH}" 2>&1) || {
    echo "yolo-cage: Error: Bootstrap failed"
    echo "$bootstrap_response"
    exit 1
}
echo "yolo-cage: Bootstrap complete"
echo "$bootstrap_response" | grep -q '"status":"success"' || {
    echo "yolo-cage: Warning: Unexpected bootstrap response"
    echo "$bootstrap_response"
}

# Register with dispatcher (maps our IP to this branch)
echo "yolo-cage: Registering with git dispatcher..."
if curl -sf -X POST "${DISPATCHER}/register?branch=${BRANCH}" >/dev/null 2>&1; then
    echo "yolo-cage: Registered successfully"
else
    echo "yolo-cage: Warning: Could not register with dispatcher. Git operations may fail."
fi

cd "$WORKSPACE"

# Run user init script if present
if [[ -x "/config/init-workspace" ]]; then
    echo "yolo-cage: Running user init script..."
    /config/init-workspace
fi

echo "yolo-cage: Initialization complete"
echo ""
echo "Branch: ${BRANCH}"
echo "Workspace: ${WORKSPACE}"
echo ""
echo "Start Claude Code with:"
echo "  claude --dangerously-skip-permissions"
echo ""

# Keep container running
exec sleep infinity
